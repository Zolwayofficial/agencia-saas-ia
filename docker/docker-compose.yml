# =========================================
# MiNuevaLLC - Docker Compose Maestro
# VPS: 12GB RAM | Groq AI (no Ollama local)
# =========================================

version: '3.8'

networks:
  saas-network:
    driver: bridge

volumes:
  postgres_data:
  nocodb_data:
  n8n_data:
  appsmith_data:
  evolution_data:
  moltbot_data:
  dify_data:
  uptime_data:
  nginx_data:
  nginx_letsencrypt:


services:
  # =========================================
  # PROXY REVERSO
  # =========================================
  nginx-proxy:
    image: 'jc21/nginx-proxy-manager:latest'
    container_name: nginx-proxy
    restart: unless-stopped
    ports:
      - '80:80'
      - '443:443'
      - '81:81' # Admin UI
    volumes:
      - nginx_data:/data
      - nginx_letsencrypt:/etc/letsencrypt
    networks:
      - saas-network
    mem_limit: 256m

  # =========================================
  # BASE DE DATOS
  # =========================================
  postgres:
    image: postgres:15-alpine
    container_name: postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-saas_admin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-change_this_password}
      POSTGRES_DB: ${POSTGRES_DB:-saas_db}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - saas-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-saas_admin}" ]
      interval: 30s
      timeout: 10s
      retries: 3
    mem_limit: 512m

  # =========================================
  # NOCODB (CRM + Base de Datos Visual)
  # =========================================
  nocodb:
    image: nocodb/nocodb:latest
    container_name: nocodb
    restart: unless-stopped
    depends_on:
      - postgres
    environment:
      NC_DB: "pg://postgres:5432?u=${POSTGRES_USER:-saas_admin}&p=${POSTGRES_PASSWORD:-change_this_password}&d=${POSTGRES_DB:-saas_db}"
      NC_AUTH_JWT_SECRET: ${NC_JWT_SECRET:-your_jwt_secret_here}
    volumes:
      - nocodb_data:/usr/app/data
    networks:
      - saas-network
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:8080/api/v1/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    mem_limit: 1g

  # =========================================
  # N8N (Orquestador de Flujos)
  # =========================================
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD:-change_this_password}
      - N8N_HOST=${N8N_HOST:-n8n.minuevallc.com}
      - N8N_PROTOCOL=https
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY:-your_encryption_key}
      - WEBHOOK_URL=https://${N8N_HOST:-n8n.minuevallc.com}
      - GENERIC_TIMEZONE=America/Lima
      - N8N_WORKFLOWS_DEFAULT_CONCURRENCY=3
    volumes:
      - n8n_data:/home/node/.n8n
    networks:
      - saas-network
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:5678/healthz" ]
      interval: 30s
      timeout: 10s
      retries: 3
    mem_limit: 1536m

  # =========================================
  # APPSMITH (Dashboards Multi-rol)
  # =========================================
  appsmith:
    image: appsmith/appsmith-ce:latest
    container_name: appsmith
    restart: unless-stopped
    volumes:
      - appsmith_data:/appsmith-stacks
    networks:
      - saas-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost/api/v1/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    mem_limit: 3g

  # =========================================
  # EVOLUTION API (WhatsApp)
  # =========================================
  evolution-api:
    image: atendai/evolution-api:v2.1.1
    container_name: evolution-api
    restart: unless-stopped
    environment:
      - SERVER_TYPE=http
      - SERVER_PORT=8080
      - CORS_ORIGIN=*
      - CORS_METHODS=GET,POST,PUT,DELETE
      - CORS_CREDENTIALS=true
      - DATABASE_ENABLED=true
      - DATABASE_CONNECTION_URI=postgresql://${POSTGRES_USER:-saas_admin}:${POSTGRES_PASSWORD:-change_this_password}@postgres:5432/${POSTGRES_DB:-saas_db}
      - DATABASE_CONNECTION_CLIENT_NAME=evolution_api
      - AUTHENTICATION_TYPE=apikey
      - AUTHENTICATION_API_KEY=${EVOLUTION_API_KEY:-your_evolution_api_key}
      - AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES=true
      - WEBHOOK_GLOBAL_ENABLED=true
      - WEBHOOK_GLOBAL_URL=http://n8n:5678/webhook/evolution
      - WEBHOOK_EVENTS_APPLICATION_STARTUP=false
      - WEBHOOK_EVENTS_MESSAGES_UPSERT=true
      - WEBHOOK_EVENTS_SEND_MESSAGE=true
    volumes:
      - evolution_data:/evolution/instances
    networks:
      - saas-network
    depends_on:
      - postgres
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    mem_limit: 1g

  # =========================================
  # MOLTBOT GATEWAY (Telegram, Discord, Matrix)
  # =========================================
  moltbot:
    image: node:22-alpine
    container_name: moltbot
    restart: unless-stopped
    working_dir: /app
    command: >
      sh -c "
        if [ ! -f /app/package.json ]; then
          npm install -g moltbot@latest &&
          moltbot init --headless
        fi &&
        moltbot start
      "
    environment:
      - MOLTBOT_AI_PROVIDER=openai
      - OPENAI_API_KEY=${GROQ_API_KEY}
      - OPENAI_BASE_URL=https://api.groq.com/openai/v1
      - MOLTBOT_MODEL=llama-3.1-8b-instant
      - MOLTBOT_WEBHOOK_URL=http://n8n:5678/webhook/moltbot
      - MOLTBOT_EXEC_APPROVALS=true
    volumes:
      - moltbot_data:/app
    networks:
      - saas-network
    mem_limit: 2g

  # =========================================
  # DIFY (LLMOps - RAG + Prompts)
  # =========================================
  dify:
    image: langgenius/dify-api:latest
    container_name: dify
    restart: unless-stopped
    environment:
      - MODE=server
      - SECRET_KEY=${DIFY_SECRET_KEY:-your_dify_secret}
      - CONSOLE_API_URL=https://ai.minuevallc.com
      - SERVICE_API_URL=https://ai.minuevallc.com
      - APP_API_URL=https://ai.minuevallc.com
      - DB_USERNAME=${POSTGRES_USER:-saas_admin}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-change_this_password}
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_DATABASE=dify
      - OPENAI_API_KEY=${GROQ_API_KEY}
      - OPENAI_API_BASE=https://api.groq.com/openai/v1
    volumes:
      - dify_data:/app/storage
    networks:
      - saas-network
    depends_on:
      - postgres
    mem_limit: 1g

  # =========================================
  # UPTIME KUMA (Monitoreo)
  # =========================================
  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: uptime-kuma
    restart: unless-stopped
    volumes:
      - uptime_data:/app/data
    networks:
      - saas-network
    mem_limit: 128m

  # =========================================
  # METABASE (Analítica Avanzada tipo Mailchimp)
  # =========================================
  metabase:
    image: metabase/metabase:latest
    container_name: metabase
    restart: unless-stopped
    environment:
      MB_DB_TYPE: postgres
      MB_DB_DBNAME: metabase
      MB_DB_PORT: 5432
      MB_DB_USER: ${POSTGRES_USER:-saas_admin}
      MB_DB_PASS: ${POSTGRES_PASSWORD:-change_this_password}
      MB_DB_HOST: postgres
    volumes:
      - metabase_data:/metabase-data
    networks:
      - saas-network
    depends_on:
      - postgres
    mem_limit: 1g

  # =========================================
  # AUTOHEAL (Reinicio automático)
  # =========================================
  autoheal:
    image: willfarrell/autoheal:latest
    container_name: autoheal
    restart: unless-stopped
    environment:
      - AUTOHEAL_CONTAINER_LABEL=all
      - AUTOHEAL_INTERVAL=30
      - AUTOHEAL_START_PERIOD=120
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    mem_limit: 64m
