FROM evoapicloud/evolution-api:latest

# Fix: pre-key upload timeout blocks sendPassiveIq('active') call.
# When uploadPreKeysToServerIfRequired() throws, sendPassiveIq is skipped
# and the connection stays open but never receives messages.
# Fix: add .catch() so pre-key failure is non-blocking.
RUN sed -i "s/await uploadPreKeysToServerIfRequired();/await uploadPreKeysToServerIfRequired().catch(e => logger.warn({ e }, 'pre-key upload failed, continuing...'));/"     /evolution/node_modules/baileys/lib/Socket/socket.js &&     echo 'Baileys pre-key patch applied:' &&     grep 'uploadPreKeysToServerIfRequired' /evolution/node_modules/baileys/lib/Socket/socket.js | head -3
